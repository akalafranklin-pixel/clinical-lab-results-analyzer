import json
import pandas as pd
from typing import Dict


class LabAnalyzer:
    def __init__(self, reference_path: str):
        with open(reference_path, "r") as file:
            self.reference_ranges = json.load(file)

    def analyze_test(
        self,
        panel: str,
        test_name: str,
        value: float,
        sex: str
    ) -> Dict:
        """
        Analyze a single lab test result.
        """

        try:
            test_info = self.reference_ranges[panel][test_name]
        except KeyError:
            raise ValueError(f"Test '{test_name}' not found in panel '{panel}'")

        lower, upper = test_info["range"][sex.lower()]
        unit = test_info["unit"]

        if value < lower:
            status = "Low"
        elif value > upper:
            status = "High"
        else:
            status = "Normal"

        return {
            "panel": panel,
            "test": test_name,
            "value": value,
            "unit": unit,
            "reference_range": f"{lower} â€“ {upper}",
            "status": status
        }

    def analyze_dataframe(self, df: pd.DataFrame) -> pd.DataFrame:
        """
        Analyze an uploaded CSV/Excel dataframe row-by-row.

        Required columns:
        - test
        - value
        - sex

        Optional:
        - panel (defaults to 'General')
        """

        results = []

        for _, row in df.iterrows():
            panel = row.get("panel", "General")
            test_name = row["test"]
            value = row["value"]
            sex = row.get("sex", "male")

            result = self.analyze_test(
                panel=panel,
                test_name=test_name,
                value=value,
                sex=sex
            )
            results.append(result)

        return pd.DataFrame(results)
